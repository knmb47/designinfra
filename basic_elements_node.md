# 基本要素 01. ノード

ノードはコンピューティングの計算ロジックの実行を管理する単位です。ノイマン型コンピュータ・アーキテクチャを構成する論理的な単位です。 つまり、中央演算装置、主記憶装置、補助記憶装置を持ち、周辺と入出力する装置がついています。今回、アーキテクチャ記述で述べるのは、2000年以降はデファクト・スタンダードとなったTCP/IP v4/v6を前提にしたネットワーク通信が可能なコンピュータ・デバイスをノードとします。また、同時に現代では当然ながらOS(Operating System、オペレーティング・システム)が動作しているものを言います。

## ノードに関する設計の大原則

ノードに関する設計上の大原則があります。

> 「ノードを分離しないで良いなら、それに越したことはない」

[なぜアーキテクチャが必要か](why_operational_model)での説明でファミコンを例に述べた通り、システムを成り立たせるプログラムを全て一つのノードに入れて満足であれば、何も問題ないのです。もう少し真面目にITシステムの例で説明します。

### メインフレーム

そのように発展し、現代まで利用されているコンピュータシステムの例はメインフレームです。メインフレームは、一台の大きなコンピュータシステムの可用性を究極まで高め信頼性を提供しています。すべての機能を一つのメインフレームで動かし、全ユーザーがログインして使うことができれば、何も多数のサーバーを管理することで生じる不便はありません。完全にクローズドな環境で防御を固め、外部に公開していない命令コードでつくればセキュリティも守りやすいでしょう。

### 単独ノードの限界

しかしながら、いかに完全な単品のコンピュータシステムにも限界はあります。幾つかの限界を考えることで、アーキテクチャの設計でノードを分離する決定のポイントを抑えたいと思います。

#### 設置場所の物理的障害

まずは、地震・停電・火災など、コンピュータシステムが置かれている場所がダメージを受ければシステムは利用できなくなります。単一ノードで動作するシステムは、設置場所に問題が起きれば、回復に時間を要することになります。ファミコンの例でも同じですが、別の場所に予備システムを用意する判断に繋がります。これで第二のノードの必要性が生じました。

#### 通信の限界１並列処理

インターネットに慣れている我々世代には想像もつかないですが、大昔はメインフレームと遠く離れた利用端末は繋がっていたのです。細かい説明は、Wikipediaの[Systems Network Architecture](https://ja.wikipedia.org/wiki/Systems_Network_Architecture)(SNA)に書いてあるとおりです。

> VTAM ( Virtual Telecommunications Access Method )とは、メインフレームコンピュータ環境で使用されるIBMの通信ソフトウェアパッケージである。
> (Wikipediaによる)

直訳すると「仮想のテレコミュニケーション接近手段」ですから、一台のメインフレームに多数の遠隔地と同時にアクセスするネットワーキング手段を提供していたようです。この時点でも、すでに「仮想」なんだなというのはさておき、問題は多重度はどの程度だったのでしょうか。

検索したら、[i SeriesのSNAの例](https://www.ibm.com/docs/ja/i/7.1?topic=capacities-communications-limits)が出てきて来てしまいましたが、まぁいいでしょう。

> 通信サブシステムに割り振る推奨最大装置数 : 250 から 300
> 
> サブシステムあたりのディスプレイ装置の最大装置記述数 : 約 74,000

最大装置数は、そんなものかなですね。一台についたサブシステムに74,000の画面は、すごい感じはしますが。とは言え、今のインターネットのWebサイトを考えたら比較にもならない小さな数字です。一台のノードで制御可能な端末は、如何に単体のコンピュータシステムの性能が上がっても限界があります。Distributed Computingが拡がったのは、メインフレームが如何に最強でも追いつかないくらい同時並列のニーズがあったからです。

大量の同時並列処理に応えるには、ノードを分割する必要があるわけです。

#### 通信の限界２通信量とレイテンシ

レイテンシーや通信量はもう一つの通信の限界です。メインフレーム上の大量データを、遠隔地のすべての端末に届けていたら無駄が沢山あるということです。計算の大事な部分は中央のノードで実行する必要があったとしても、画面表示のプログラムや妥当性のチェックは手前で行っておけば無駄に通信量を使う必要はありません。通信量が増えれば、個別の端末とのやり取りに使える帯域が減り、レイテンシが遅くなります。何らかのキャッシュを手前に持ってくることが解決の一つです。TERMINAL変数で有名な [vt100](https://ja.wikipedia.org/wiki/VT100) はDEC社のビデオターミナル端末で、特殊文字を画面レイアウトしてくれるプログラムを持つ、一種のキャッシュを持ったテクニカルノードとして機能し、画面制御に必要なデータ通信を最小限に留めてくれます。

キャッシュを持つテクニカルノードをエンドポイント側に持ちたくなって来たわけです。これは、今日においては、[Content Delivery Network (CDN)](https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%83%87%E3%83%AA%E3%83%90%E3%83%AA%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF)の概念です。

#### セキュリティの確保

冒頭で述べた通り、誰ともつながっていないシステムであれば、守りを固めることもできるかもしれません。ゼロトラストセキュリティの時代に古臭い境界防御の話か…と思われるかもしれませんが、境界防御なく丸出しなわけでもありません。通信は許可するもののシステムを守る仕組みは必要です。一昔前と違い攻撃も多様性の時代です。サービスを台無しにするために、過負荷を掛けてくるかもしれません。律儀に全てに応答するのではなく、中間にテクニカルノードを挟むことでサーキットブレーカーを入れる必要もあるでしょう。リモート拠点の単位でサーキットブレーカーを入れれば、攻撃を受けた拠点はサービスが受けられませんが、他の拠点はサービスを継続できる可能性があります。サーキットブレーカーのノードを複数持ちたくなってきました。

その他にも境界防御のセキュリティでは中継サーバーでユーザーをセキュリティ認証するような関所の役割も持たせることになります。

#### 大規模更新

巨大で単一のメインフレームで、システムの入れ替えに一日かかるとしたら、経済損失が如何ばかりか想像もつかない…。そんな場合には、[ブルー・グリーン・デプロイメント](https://en.wikipedia.org/wiki/Blue-green_deployment)を行いたくなりますね。ブルー・グリーン・デプロイメントは分散システムの専売特許ではありません。[大昔(30年前)から行われている](https://www.ibm.com/blogs/systems/jp-ja/fighting-story-of-ibm-se-and-it-infrastructure/)わけです。DevOpsだのSREだのは、リピータブルに、その辺でもできるまで簡便な実装がほぼ無料で入手できるようになって実装が楽なだけです。

いまや、[Live Partition Mobility](https://www.ibm.com/docs/ja/power7?topic=POWER7/p7hc3/iphc3kickoff.html)で、AIXのOS動作でさえもノード間を移動しちゃうんですから驚きです。

### ノード分割のまとめ

メインフレームを材料に「全部一個の箱でいいじゃん」ではないケースを確認してきました。LinuxやWindowsやiPhone等の時代に、あえてメインフレームで説明したのは理由があります。実装技術があるから実装するのではなく、「何の非機能要件」が「どういう事情」で存在し「それらをどう行った方式で解決しているのか？」を解説したかったためです。方式にはメインフレームもiPhoneアプリも根本コンセプトに違いはありません。もちろん、ニーズの量や実装の入手の容易性に大きな幅がありますが。。。入手の容易性で安易に決定しないで欲しいな…という願いを込めています。


## ノードへの配置

さて、非機能要件を高めるためのノード分割が必要なことはわかりました。前述の色んな理由で複数になるノードには、作成するコンポーネントを載せる必要があります。実行プログラムとして、マスターなデータとして、実行の単位を決める必要が出てきます。その際に出てくるのが、デプロイメントユニットです。

というところで、もう、今日はつかれたのでここまで。。。






